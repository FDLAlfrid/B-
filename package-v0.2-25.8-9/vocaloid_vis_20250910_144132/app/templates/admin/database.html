{% extends "base.html" %}

{% block title %}数据库管理 - VOCALOID音乐社交平台{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="text-center mb-6">数据库管理</h1>
    
    <!-- 统计信息卡片 -->
    <div class="row mb-8">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">音乐总数</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_music }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-music fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 其他统计卡片保持不变 -->
    </div>
    
    <!-- 数据抓取功能 -->
    <div class="card shadow mb-8">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">数据抓取</h6>
        </div>
        <div class="card-body">
            <form id="fetchDataForm">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="fetchRids">抓取分区</label>
                        <select id="fetchRids" name="rids" multiple class="form-control">
                            <option value="30" selected>VOCALOID·UTAU (rid=30)</option>
                            <option value="29" selected>华语 (rid=29)</option>
                            <option value="190" selected>其他 (rid=190)</option>
                        </select>
                        <small class="form-text text-muted">按住Ctrl键可选择多个分区</small>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="fetchLimit">每个分区抓取数量</label>
                        <input type="number" id="fetchLimit" name="limit" class="form-control" value="50" min="1" max="200">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="forceUpdate">强制更新</label>
                        <select id="forceUpdate" name="force_update" class="form-control">
                            <option value="false" selected>否（只保存新数据）</option>
                            <option value="true">是（覆盖所有数据）</option>
                        </select>
                    </div>
                    <div class="form-group col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-download"></i> 抓取数据
                        </button>
                    </div>
                </div>
                <div class="form-row mt-3">
                    <div class="col-md-12">
                        <div id="fetchStatus" class="text-muted small"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 历史排行榜查询 -->
    <!-- 这部分保持不变 -->
    
    <!-- 数据清理功能 -->
    <!-- 这部分保持不变 -->
    
    <!-- 数据导出功能 -->
    <!-- 这部分保持不变 -->
</div>

<script>
// 页面加载时获取统计信息
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseStats();
    
    // 设置默认日期
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('export-start-date').value = today;
    document.getElementById('export-end-date').value = today;
});

// 加载数据库统计信息
function loadDatabaseStats() {
    fetch('/admin/api/database-stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-music').textContent = data.total_music;
            document.getElementById('total-shares').textContent = data.total_shares;
            document.getElementById('total-favorites').textContent = data.total_favorites;
            document.getElementById('total-users').textContent = data.total_users;
        })
        .catch(error => console.error('Error:', error));
}

// 历史排行榜查询
document.getElementById('historical-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const date = document.getElementById('history-date').value;
    
    fetch('/admin/api/historical-rankings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ date: date })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const resultsDiv = document.getElementById('historical-results');
            const title = document.getElementById('results-title');
            const body = document.getElementById('results-body');
            
            title.textContent = `${data.date} 排行榜 (共 ${data.count} 条数据)`;
            body.innerHTML = '';
            
            data.data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.ranking}</td>
                    <td title="${item.title}">${item.title.length > 20 ? item.title.substring(0, 20) + '...' : item.title}</td>
                    <td>${item.author}</td>
                    <td>${item.view_count.toLocaleString()}</td>
                `;
                body.appendChild(row);
            });
            
            resultsDiv.style.display = 'block';
        } else {
            alert('查询失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('查询失败');
    });
});

// 数据清理
document.getElementById('cleanup-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirm('确定要清理数据吗？此操作不可恢复！')) {
        return;
    }
    
    const days = document.getElementById('days-to-keep').value;
    const backup = document.getElementById('enable-backup').checked;
    
    fetch('/admin/api/cleanup-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            days: parseInt(days), 
            backup: backup 
        })
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('cleanup-results');
        const alertDiv = document.getElementById('cleanup-alert');
        
        if (data.success) {
            alertDiv.className = 'alert alert-success';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> ${data.message}
                <br><small>清理截止时间: ${data.data.cutoff_date}</small>
            `;
            
            // 刷新统计信息
            loadDatabaseStats();
        } else {
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> 清理失败: ${data.error}`;
        }
        
        resultsDiv.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('清理失败');
    });
});

// 数据导出
document.getElementById('export-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    const format = document.getElementById('export-format').value;
    
    fetch('/admin/api/export-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            start_date: startDate, 
            end_date: endDate,
            format: format
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 创建下载链接
            const blob = new Blob([data.data], { type: format === 'json' ? 'application/json' : 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`数据已导出: ${data.filename}`);
        } else {
            alert('导出失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('导出失败');
    });
});
// 数据抓取功能
$(document).ready(function() {
    // 数据抓取表单提交事件
    $('#fetchDataForm').on('submit', function(e) {
        e.preventDefault();
        
        // 显示确认对话框
        if (!confirm('确定要从B站抓取数据吗？这可能需要一些时间。')) {
            return;
        }
        
        // 获取表单数据
        const rids = $('#fetchRids').val() || [];
        const limit = parseInt($('#fetchLimit').val()) || 50;
        const forceUpdate = $('#forceUpdate').val() === 'true';
        
        // 显示加载状态
        $('#fetchStatus').html('<span class="text-info"><i class="fas fa-spinner fa-spin"></i> 正在抓取数据...</span>');
        
        // 发送请求
        $.ajax({
            url: '/admin/api/fetch-data',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                rids: rids.map(rid => parseInt(rid)),
                limit: limit,
                force_update: forceUpdate
            }),
            success: function(response) {
                if (response.success) {
                    $('#fetchStatus').html(`<span class="text-success"><i class="fas fa-check-circle"></i> 抓取成功！共抓取 ${response.data.total_fetched} 条数据，保存 ${response.data.total_saved} 条新数据</span>`);
                    // 刷新统计信息
                    refreshStats();
                } else {
                    $('#fetchStatus').html(`<span class="text-danger"><i class="fas fa-exclamation-circle"></i> 抓取失败: ${response.error}</span>`);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = '网络错误，请稍后重试';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {}
                $('#fetchStatus').html(`<span class="text-danger"><i class="fas fa-exclamation-circle"></i> 抓取失败: ${errorMessage}</span>`);
            }
        });
    });
    
    // 刷新统计信息函数
    function refreshStats() {
        $.ajax({
            url: '/admin/api/database-stats',
            type: 'GET',
            success: function(response) {
                // 更新统计卡片
                $('.card-body .font-weight-bold.text-gray-800:contains("音乐总数")').parent().siblings().find('.h5').text(response.total_music);
                // 这里可以更新其他统计信息
            }
        });
    }
    
    // 数据清理功能
    // 这部分保持不变
    
    // 数据导出功能
    // 这部分保持不变
});
</script>
{% endblock %}